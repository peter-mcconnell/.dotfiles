#!/bin/bash

# inspired by @jfrazelle

### docker client aliases
d_p() {
	docker ps "${@}"
}

d_c() {
	docker rm -f `docker ps -aq` 2> /dev/null
	docker rm -v `docker ps --filter status=exited -q 2>/dev/null` 2>/dev/null
	docker rmi `docker images --filter dangling=true -q 2>/dev/null` 2>/dev/null
	echo "cleaned"
}

# simple wrapping method that follows a containers logs
_docker_logwrap() {
	docker logs -f `$1`
}
_docker_relieson(){ # taken from: https://github.com/jfrazelle/dotfiles/blob/master/.dockerfunc
	local containers=$@

	for container in $containers; do
		local state=$(docker inspect --format "{{.State.Running}}" $container 2>/dev/null)

		if [[ "$state" == "false" ]] || [[ "$state" == "" ]]; then
			echo "$container is not running, starting it for you."
			$container
		fi
	done
}

### container aliases
# Usage: d_vim ~/path/to/file (just make sure this is mounted, obvs)
d_vim() {
	vimargs=""
	if [ "${1}" != "" ]; then
		vimargs=`echo "$(cd "$(dirname "$1")"; pwd)/$(basename "$1")"`
	fi
	docker run --rm \
		-v /private/etc/passwd:/etc/passwd:ro \
		-v /private/etc/group:/etc/group:ro \
		-v $HOME:$HOME \
		-w $HOME \
		-u $(id -u) \
		-ti pemcconnell/vimothy:0.1 vim $vimargs
}

d_cid() {
	d_registry
	d_mesosphere
	d_gitlab
	d_jenkins
}

d_registry() {
	if [ "${1}" = "l" ]; then _docker_logwrap "${FUNCNAME[0]}"; return; fi
	docker run \
		-d \
		-p 5000:5000 \
		--restart=always \
		--name registry \
		registry:2
}

d_jenkins() {
	if [ "${1}" = "l" ]; then _docker_logwrap "${FUNCNAME[0]}"; return; fi
	docker run \
		--add-host localhost:"${LOCALIP}" \
		--add-host marathon:"${LOCALIP}" \
		-p 8080:8080 \
		-p 50000:50000 \
		-v $HOME/v/jenkins_home:/var/jenkins_home \
		-v $HOME/v/jenkins_user:/root \
		-u 0 \
		-w /root \
		-v /var/run/docker.sock:/var/run/docker.sock \
		-v "${HOME}/bin/docker/docker-Li386:/usr/bin/docker" \
		-v /etc/localtime:/etc/localtime:ro \
		--name jenkins \
		-d \
		jenkinsci/jenkins:latest
}

d_mesosphere() {
	if [ "${1}" = "l" ]; then _docker_logwrap "${FUNCNAME[0]}"; return; fi
	# zookeeper
	docker run -d \
		--restart always \
		-p 2181:2181 \
		-p 2888:2888 \
		-p 3888:3888 \
		--name zookeeper \
		netflixoss/exhibitor:1.5.2 1>/dev/null

	#Â master
	docker run -d \
		--restart always \
		-p 5050:5050 \
		--link zookeeper:zk \
		-e MESOS_PORT=5050 \
		-e MESOS_ZK="zk://zk:2181/mesos" \
		-e MESOS_QUORUM=1 \
		-e MESOS_REGISTRY=in_memory \
		-e MESOS_LOG_DIR=/var/log/mesos \
		-e MESOS_WORK_DIR=/var/lib/mesos \
		--name mesos-master \
		mesosphere/mesos-master:0.28.0-2.0.16.ubuntu1404 1>/dev/null

	# slave
	docker run -d \
		--restart always \
		--link zookeeper:zk \
		--link mesos-master:master \
		-p 5051:5051 \
		-e MESOS_SWITCH_USER=0 \
		-e MESOS_CONTAINERIZERS=docker,mesos \
		-e MESOS_PORT=5051 \
		-e MESOS_HOSTNAME="${LOCALIP}" \
		-e MESOS_MASTER=zk://zk:2181/mesos \
		-e MESOS_LOG_DIR=/var/log/mesos \
		-v /sys/fs/cgroup:/sys/fs/cgroup \
		-v /var/run/docker.sock:/var/run/docker.sock \
		-v "${HOME}/bin/docker/docker-Li386:/usr/bin/docker" \
		--name mesos-slave \
		mesosphere/mesos-slave:0.28.0-2.0.16.ubuntu1404

	# marathon
	docker run \
		-d \
		--restart always \
		-p 8787:8080 \
		--link zookeeper:zk \
		mesosphere/marathon:latest \
		--master zk://zk:2181/mesos --zk zk://zk:2181/marathon 1>/dev/null
}

d_nexus() {
	if [ "${1}" = "l" ]; then _docker_logwrap "${FUNCNAME[0]}"; return; fi
	docker run \
		--add-host gitlab:"${LOCALIP}" \
		--add-host jenkins:"${LOCALIP}" \
		-p 8081:8081 \
		-v $HOME/v/nexus:/nexus-data \
		--name nexus \
		-d \
		sonatype/nexus3:latest
}

d_gitlab() {
	if [ "${1}" = "l" ]; then _docker_logwrap "${FUNCNAME[0]}"; return; fi
	docker run \
		--add-host jenkins:"${LOCALIP}" \
		--add-host nexus:"${LOCALIP}" \
		-p 80:80 \
		-p 443:443 \
		-p 22:22 \
		-v $HOME/v/gitlab/config:/etc/gitlab \
		-v $HOME/v/gitlab/logs:/var/log/gitlab \
		-v $HOME/v/gitlab/data:/var/opt/gitlab \
		-e GITLAB_OMNIBUS_CONFIG="external_url 'http://gitlab'" \
		--name gitlab \
		-d \
		gitlab/gitlab-ce:latest
}

d_postgres() {
	if [ "${1}" = "l" ]; then _docker_logwrap "${FUNCNAME[0]}"; return; fi
	docker run \
		-p 5432:5432 \
		-e POSTGRES_USER=root \
		-e POSTGRES_PASSWORD=pass \
		--name postgres \
		-d \
		postgres:9.6
}

d_mysql() {
	if [ "${1}" = "l" ]; then _docker_logwrap "${FUNCNAME[0]}"; return; fi
	docker run \
		-p 3306:3306 \
		-e MYSQL_USER=root \
		-e MYSQL_PASSWORD=pass \
		-v $HOME/v/mysql:/var/lib/mysql \
		--name mysql \
		-d \
		mysql:5.7
}

d_mongo() {
	if [ "${1}" = "l" ]; then _docker_logwrap "${FUNCNAME[0]}"; return; fi
	docker run \
		-p 27017:27017 \
		-v $HOME/v/mongodb:/data/db \
		--name mongodb \
		-d \
		mongo:3.3.8;
}

d_mongouser() {
	if [ "${1}" = "l" ]; then _docker_logwrap "${FUNCNAME[0]}"; return; fi
	docker exec \
		-ti \
		mongodb \
		mongo admin --eval "db.createUser({user: 'root', pwd: 'pass', roles:[{role:'root',db:'admin'}]});";
}

d_nginx() {
	if [ "${1}" = "l" ]; then _docker_logwrap "${FUNCNAME[0]}"; return; fi
	docker run \
		-p 80:80 \
		--name nginx \
		-d \
		nginx:1.11.1
}

d_http() {
	if [ "${1}" = "l" ]; then _docker_logwrap "${FUNCNAME[0]}"; return; fi
	docker run \
		--rm \
		-ti \
		clue/httpie:latest "$@"
}
